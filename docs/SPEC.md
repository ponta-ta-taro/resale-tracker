# ResaleTracker V2 - 仕様書

## 1. 背景・前提条件

### 1.1 プロジェクト概要
iPhone転売ビジネスのための在庫管理・利益計算アプリケーション。
仕入れから買取業者への販売までの進捗を管理し、利益・経費・ポイント・送料も一元管理する。

### 1.2 Apple転売防止対策
Appleは1アカウントで大量購入すると転売屋と判定し、出荷停止する可能性がある。

**対策として以下の運用を行う：**

| 購入方法 | 説明 | 使用頻度 |
|---------|------|---------|
| Apple ID | 自分のアカウントで購入 | 時々 |
| ゲストID | アカウント不要で購入 | ほとんど |

**連絡先情報：**
- メールアドレス：10〜20個のGmailを使い分け
- 電話番号：デタラメでもOK（実際に連絡が来ることはない）

### 1.3 メール取り込みの流れ
```
Apple（ゲスト購入）
    ↓
各Gmail（連絡先メールとして登録、10〜20個）
    ↓ フィルター: @orders.apple.com OR @email.apple.com を転送
import@rt-mail.uk（Cloudflare Email Worker）
    ↓
ResaleTracker API → 在庫自動登録 + メール履歴保存
```

### 1.4 Amazonからの購入
- Amazonは基本的に1注文1台のみ
- メール取り込みは**手動**（emlファイルをアップロード）

---

## 2. 機能一覧

### 2.1 コア機能

| 機能 | 説明 |
|------|------|
| 在庫管理 | iPhoneの仕入れ〜販売までの進捗管理 |
| メール自動取り込み | Appleからのメールを解析して在庫自動登録 |
| 価格トラッキング | モバイルミックスの買取価格を毎日自動収集 |
| 利益計算 | 粗利益（売上-仕入）、純利益（粗利-送料）の自動計算 |

### 2.2 補助機能

| 機能 | 説明 |
|------|------|
| 送料管理 | 発送単位で送料を記録、複数商品の同梱対応 |
| ポイント・特典管理 | ギフトカード還元、クレカポイントの記録 |
| メール履歴 | 取り込んだメールの履歴確認 |
| 設定管理 | Apple ID、連絡先メール、支払い方法などのマスタ管理 |

### 2.3 将来機能

| 機能 | 説明 |
|------|------|
| 価格予測 | 過去データから将来の買取価格を予測（Azure ML） |
| アンケートリマインダー | Apple購入後のアンケート回答を促す |
| 注文状況URLスクレイピング | Appleゲスト注文ページをスクレイピングしてステータス自動取得（処理中→配送準備中など、メールより早く検知できる可能性） |

---

## 3. ステータス定義

在庫アイテムは以下の9段階のステータスで管理する。
**Apple側の5段階** + **買取側の4段階** で構成。

### 3.1 ステータス一覧

| # | ステータス | 表示名 | フェーズ | トリガー |
|---|-----------|--------|---------|---------|
| 1 | `ordered` | 注文確定 | Apple | 注文確認メール受信時 |
| 2 | `processing` | 処理中 | Apple | Apple側でステータス変更時 |
| 3 | `preparing_shipment` | 配送準備中 | Apple | Apple側でステータス変更時 |
| 4 | `shipped` | 出荷完了 | Apple | 出荷通知メール受信時（追跡番号取得） |
| 5 | `delivered` | 配送済み | Apple | 納品日が入力された時 |
| 6 | `sent_to_buyer` | 買取発送済み | 買取 | 買取業者への伝票番号が入力された時 |
| 7 | `buyer_completed` | 買取手続完了 | 買取 | 売却日が入力された時 |
| 8 | `paid` | 入金済み | 買取 | 入金日が入力された時 |
| 9 | `receipt_received` | 領収書受領 | 買取 | 領収書受領日が入力された時 |

### 3.2 ステータス進捗バー表示

**Apple側**
```
●───●───●───○───○
注文  処理中 配送  出荷  配送
確定       準備中 完了  済み
```

**買取側**
```
●───○───○───○
買取  手続  入金  領収書
発送  完了  済み  受領
```

### 3.3 お届け予定日アラート

- **当初お届け予定日**（`original_delivery_start` / `original_delivery_end`）を保存
- 現在の**お届け予定日**（`expected_delivery_start` / `expected_delivery_end`）と比較
- 後ろ倒しになった場合、ダッシュボードにアラート表示

```
【アラート】
⚠️ お届け予定日変更: 2件
  - W1234567890: 1/20-21 → 1/27-2/3（6日遅延）
  - W0987654321: 1/22-23 → 1/25-26（3日遅延）
```

---

## 4. メール種類と取得情報

### 4.1 サンプルメールの格納場所

サンプルメールは `docs/email-samples/` に格納している。

| 種類 | 形式 | 備考 |
|------|------|------|
| Appleアカウントで購入したメール | PDF | iCloudメールに届くため.emlにできない |
| ゲストアカウントで購入したメール（Gmail宛） | .eml | 納品未完了のため全種類揃っていない |

**注意事項：**
- Appleアカウント購入 → iCloudメールに届く → PDF形式で保存
- ゲスト購入（Gmail連絡先）→ Gmailに届く → .eml形式で保存可能

### 4.2 対象メール一覧

| # | 件名パターン | 送信元 | 処理内容 |
|---|-------------|--------|---------|
| 1 | ご注文の確認 - W{注文番号} | @orders.apple.com | 在庫レコード作成（ステータス: ordered） |
| 2 | ご注文ありがとうございます W{注文番号} | @orders.apple.com | 在庫レコード更新（お届け予定日の更新） |
| 3 | お客様の商品は配送中です | @orders.apple.com | 追跡番号登録（ステータス: shipped） |
| 4 | 請求金額のお知らせ | @email.apple.com | PDF解析 → シリアル番号・IMEI登録 |
| 5 | ご購入時の体験はいかがでしたか？ | @email.apple.com | アンケートリマインダー表示 |

### 4.3 各メールから取得する情報

#### メール1: 注文確認
- 注文番号（order_number）
- 注文日（order_date）
- 機種名（model_name）
- 容量（storage）
- カラー（color）
- 価格（purchase_price）
- お届け予定日（expected_delivery_start / end）
- 連絡先メール（contact_email）
- 支払い方法（payment_method）

#### メール2: 注文ありがとう
- 注文番号（照合用）
- お届け予定日（更新があれば上書き）

#### メール3: 出荷通知
- 注文番号（照合用）
- 配送業者（carrier）
- 追跡番号（tracking_number）
- お届け予定日（更新があれば上書き）

#### メール4: 請求書PDF
- 注文番号（照合用）
- シリアル番号（serial_number）
- IMEI（imei）
- 請求番号（invoice_number）

### 4.4 重複取り込み防止

**識別キー**: `order_number` + `item_index`

- 1注文で複数台購入した場合、item_indexで区別
- 例: W1515122271-1, W1515122271-2
- 同じキーのメールが来たら更新（上書き）

---

## 5. 画面構成

### 5.1 画面一覧

| パス | 画面名 | 説明 |
|------|--------|------|
| / | ダッシュボード | 今月の実績、在庫状況、アラート |
| /inventory | 在庫一覧 | 全在庫の一覧表示、フィルター、ソート |
| /inventory/new | 在庫登録 | 新規在庫の手動登録 |
| /inventory/[id] | 在庫詳細 | 在庫の詳細表示・編集 |
| /prices | 価格一覧 | 買取価格の一覧・グラフ |
| /emails | メール履歴 | 取り込んだメールの履歴 |
| /settings | 設定 | 各種マスタ管理 |
| /settings/apple-accounts | Apple ID管理 | Apple IDの登録・編集 |
| /settings/contacts | 連絡先管理 | メール・電話番号の登録・編集 |
| /settings/payment-methods | 支払い方法管理 | クレカ等の登録・編集 |
| /login | ログイン | Google認証 |

### 5.2 在庫登録フォーム構成

```
📊 ステータス（最上部・進捗バー付き）

📦 基本情報
  - 機種 / 容量 / カラー
  - 注文番号 / item_index
  - 仕入先（Apple Store / Amazon）
  - 支払い方法
  - 購入Apple ID
  - 連絡先メール / 電話番号

📅 日付情報（Apple側）
  - 注文日
  - お届け予定日（開始・終了）
  - 当初お届け予定日（開始・終了）← 遅延検知用
  - 納品日

📦 Apple配送情報
  - 配送業者
  - 追跡番号

💰 価格情報
  - 仕入価格
  - 予想売価（注文時）
  - 実売価格

🚚 買取・販売情報
  - 販売先
  - 配送業者 / 伝票番号
  - 発送日 / 売却日 / 入金日 / 領収書受領日

📝 その他
  - 備考
```

### 5.3 ダッシュボード表示項目

```
【今月の実績】
売上: ¥XXX,XXX（X台）
仕入: ¥XXX,XXX
粗利益: ¥XX,XXX
送料: ¥X,XXX
純利益: ¥XX,XXX

【ポイント・特典（今月）】
ギフトカード還元: ¥X,XXX
クレカポイント: ¥X,XXX
合計: ¥X,XXX

【在庫状況】
注文確定: X台
出荷完了: X台
配送済み: X台
入金待ち: X台

【アラート】
⚠️ お届け予定日変更: X件
⚠️ アンケート未回答: X件
```

---

## 6. 今後の予定

### Phase 1: 基盤構築（現在）
- [x] Supabase + Next.js環境構築
- [x] Google認証 + RLS
- [x] 価格スクレイピング（Render）
- [ ] ドキュメント整備（SPEC, DATABASE, RULES）

### Phase 2: 在庫管理リビルド
- [ ] inventory_v2テーブル移行
- [ ] 新フォームUI実装
- [ ] ステータス進捗バー実装

### Phase 3: メール自動取り込み
- [ ] Gmail転送設定（全アカウント）
- [ ] Cloudflare Worker改修
- [ ] 全メールタイプ対応

### Phase 4: 補助機能
- [ ] 送料管理
- [ ] ポイント・特典管理
- [ ] アンケートリマインダー

### Phase 5: 価格予測（将来）
- [ ] Azure ML連携
- [ ] 予測グラフ表示
