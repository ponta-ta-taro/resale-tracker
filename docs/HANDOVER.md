# ResaleTracker 開発引き継ぎメモ

> **運用ルール**
> - このファイルは常に最新の状態に上書き更新する
> - 大きな進捗（Phase完了、新機能実装完了）があったら `docs/handover/日付.md` にアーカイブ
> - 決定事項・技術詳細は `docs/V2_DECISIONS.md` を参照

---

## 現在の状態

**運用フェーズ** - 実運用開始、UI/UX改善中

---

## 本番URL

| サービス | URL |
|---------|-----|
| **Webサイト** | https://resale-tracker-opal.vercel.app |
| **GitHub** | https://github.com/ponta-ta-taro/resale-tracker |
| **Supabase** | https://supabase.com/dashboard （プロジェクト: resale-tracker） |
| **Render** | https://dashboard.render.com （サービス: resale-tracker-scraper） |
| **Cloudflare** | Email Worker（import@rt-mail.uk） |

---

## 完了済み（2026/01/21）

- [x] **データ初期化**: inventory, email_logs削除、過去メール一括転送で再登録
- [x] **ダッシュボードステータス修正**: DATABASE.mdの9ステータスに統一
- [x] **在庫編集画面改善**:
  - マスタ選択フィールド追加（支払い方法、連絡先メール、電話番号、Apple ID）
  - ラベル変更「Apple配送情報」→「Appleからの配送情報」
  - 実売価格バリデーション（売却日・入金日入力時に必須、条件付き警告表示）
- [x] **在庫一覧改善**: 予想売価・実売価列を追加
- [x] **ダッシュボード在庫状況改善**:
  - 「販売中」→「買取手続き中」に変更
  - 「入金待ち」削除（4項目表示に）
- [x] **ダッシュボード期間選択機能**: 当月/前月/カスタム期間で切り替え可能
- [x] **累計実績セクション追加**: 総売上、総粗利益、総利益率、総送料、総純利益、総販売台数
- [x] **カード内ラベル変更**: 「今月の売上」→「売上」等、「今月の」を削除
- [x] **資金状況表示名変更**: 「仕入れ総額（未回収）」→「未回収の仕入れ総額」
- [x] **設定画面ドラッグ&ドロップ並び替え**: @dnd-kit使用、4テーブル対応
- [x] **支払いスケジュール並び順対応**: 設定画面の並び順がダッシュボードに反映
- [x] **DBスキーマ更新**: 4テーブルにsort_orderカラム追加
- [x] **DB整理**: V1残骸テーブル6つ削除（inventory_v2, credit_cards, early_repayments, mobile_lines, models, shipping_addresses）
- [x] **ヘルプページ作成**: 初期設定手順、各機能説明、FAQ（app/help/page.tsx）
- [x] **Gmail転送確認メール処理**: 
  - `forwarding-noreply@google.com` からの確認メールを自動検知
  - base64デコード対応
  - メール履歴画面で確認リンクを表示（承認待ちステータス）
  - ユーザーがアプリ内で転送承認を完結可能に
- [x] **ゲストIDデフォルト登録**: 新規ユーザー登録時に `apple_accounts` に「ゲストID」を自動作成
- [x] **ヘルプページ大幅更新**:
  - マスターデータ登録の説明追加
  - Gmail転送設定4ステップを詳細に記載
  - 対応メール一覧を表形式で整理
  - 色分け・アイコンで視覚的に分かりやすく
- [x] **マスターデータ削除時の警告**: 4テーブル（Apple ID、支払い方法、連絡先メール、連絡先電話番号）で使用中チェックを追加

---

## 次にやること

### 優先度高
- [ ] メール貼り付けパース機能（V1から移行）

### 優先度中
- [ ] 他の買取業者のスクレイピング追加（イオシス、じゃんぱら等）
- [ ] メール履歴UIの改善（「確認リンクを開く」ボタンを直接表示）

### 優先度低（必要に応じて）
- 未対応メール整理
  - 「ご注文ありがとうございます」- 注文確認と重複？要検討
  - 「請求金額のお知らせ」- 請求書対応するか検討

### 将来の拡張候補
- 価格比較ツール（is-checker.com のような複数業者比較）
- Apple Store在庫確認機能
- 価格履歴との連携（モバイルミックスデータ活用）
- 複数ユーザー対応

---

## 技術メモ

### ダッシュボードロジック

#### 期間選択対応の実績
| 項目 | ロジック |
|------|---------|
| 売上 | `paid` かつ `paid_at` が期間内 → `actual_price` 合計 |
| 粗利益 | 同上 → `actual_price - purchase_price` 合計 |
| 送料 | `shipments.shipped_at` が期間内 → `shipping_cost` 合計 |
| 純利益 | 粗利益 - 送料 |
| 利益率 | 粗利益 ÷ 仕入総額 × 100 |
| 販売台数 | `paid` かつ `paid_at` が期間内 → 件数 |

#### 在庫状況（4項目）
| 項目 | ステータス |
|------|-----------|
| 注文中 | ordered + processing + preparing_shipment |
| 出荷済み | shipped |
| 配送済み | delivered |
| 買取手続き中 | sent_to_buyer + buyer_completed |

### 並び替え機能
- 4テーブルに`sort_order`カラム追加済み
- @dnd-kit使用でドラッグ&ドロップUI
- reorder API: PUT /api/{テーブル名}/reorder
- ダッシュボード支払いスケジュールにも反映

---

## 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| `V2_DECISIONS.md` | **決定事項・技術詳細** |
| `SPEC.md` | V2仕様書（要件、機能、画面構成） |
| `DATABASE.md` | テーブル定義（9テーブル） |
| `API.md` | APIエンドポイント一覧 |
| `RULES.md` | コーディング規約 |
| `SETUP.md` | 環境構築手順 |
| `email-samples/` | メールサンプル |
| `handover/` | アーカイブ（過去の引き継ぎメモ） |
